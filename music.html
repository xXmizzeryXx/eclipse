<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>music - eclipse.</title>
  <link rel="icon" type="image/x-icon" href="assets/favicon/favicon.png" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Raleway:wght@300;400&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="assets/css/styles.css">
  <style>
    header.top-bar .logo { font-size: 28px; }
    .content { padding: 28px; }
    .player-area { max-width: 900px; }
    /* Playlist sidebar (match game-modal styles) */
    .sidebar.playlist { width:320px; background:#1e160b; border-radius:12px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,0.4); }
    .sidebar.playlist h4{margin:0 0 12px 0;font-size:14px;color:#b88640;text-transform:uppercase}
    .game-list{display:flex;flex-direction:column;gap:10px;overflow:auto;max-height:60vh;padding-right:6px}
    .side-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;background:rgba(0,0,0,0.05);cursor:pointer;color:#eee;text-decoration:none}
    .side-item.active{background:#b88640;color:#0f0e0e}
    .side-item .name{font-weight:700;font-size:14px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
    .side-item .cat{font-size:11px;color:#bdb1a0;text-transform:uppercase;margin-top:4px}
    .side-item .meta{display:flex;flex-direction:column;flex:1;min-width:0;margin-right:8px}
    .btn{background:transparent;border:2px solid #b88640;color:#b88640;padding:6px 10px;border-radius:8px;cursor:pointer}
    .btn.small{padding:4px 8px;font-size:12px}
  </style>
</head>
<body>

  <video id="videoBG" autoplay muted loop playsinline>
    <source src="assets/bg/background.mp4" type="video/mp4">
  </video>

  <div class="app">
    <!-- Sidebar -->
    <nav class="sidebar" aria-label="Main sidebar navigation">
      <div class="icon" title="Home" onclick="window.location.href='index.html'"><i class="fa-solid fa-house"></i></div>
      <div class="icon" title="Browser" onclick="window.location.href='frame.html'"><i class="fa-solid fa-globe"></i></div>
      <div class="icon" title="Emergency Cloaking" id="emergencyCloakBtn"><i class="fa-solid fa-moon"></i></div>
      <div class="icon" title="Games" onclick="window.location.href='games.html'"><i class="fa-solid fa-gamepad"></i></div>
      <div class="icon active" title="Music" onclick="window.location.href='music.html'"><i class="fa-solid fa-headphones"></i></div>
      <div class="icon" title="Credits" onclick="window.location.href='credits.html'"><i class="fa-solid fa-book"></i></div>
      <div class="icon" title="Settings" onclick="window.location.href='settings.html'"><i class="fa-solid fa-cog"></i></div>
    </nav>

    <!-- Main content -->
    <main class="content" role="main">

      <!-- Header / Branding -->
      <header class="top-bar">
        <h1 class="logo" aria-label="Eclipse branding">eclipse<span class="dot">.</span></h1>
      </header>

      <div class="player-area">
        <h2 style="color:#b88640; margin-bottom:16px;">Music Player</h2>

        <div class="search-bar" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
          <label for="fileUpload" class="btn" style="border-color:#b88640;color:#b88640;">Upload MP3</label>
          <input id="fileUpload" type="file" accept="audio/*" multiple style="display:none;" />
        </div>

        <div id="playerContainer" style="margin-top:24px; display:flex; gap:16px; align-items:flex-start;">
          <div style="flex:1; display:flex; flex-direction:column; gap:12px;">
              <audio id="audioPlayer" controls style="width:100%; border-radius:12px; background:#1e160b; display:block;"></audio>
            <div id="uploadHint" style="color:#bdb1a0;font-size:13px">You can also drag & drop MP3 files here.</div>
          </div>

          <aside class="sidebar playlist" aria-label="Playlist">
            <h4>Playlist</h4>
            <div class="game-list" id="playlist"></div>
          </aside>
        </div>
      </div>

    </main>
  </div>

  <!-- Status bar -->
  <footer class="status-bar" aria-label="Status bar">
    <span class="status-dot" aria-hidden="true"></span>
    <span>Connected</span>
    <span>â€¢</span>
    <span>Music</span>
  </footer>

  <script>
    // Upload-only playlist with persistence (IndexedDB + localStorage)
    const fileInput = document.getElementById('fileUpload');
    const playlistEl = document.getElementById('playlist');
    const audioPlayer = document.getElementById('audioPlayer');
    const uploadHint = document.getElementById('uploadHint');
    const playerContainer = document.getElementById('playerContainer');

    const STORAGE_KEY = 'eclipse_playlist_v1';
    const DB_NAME = 'eclipse_music_db';
    const STORE_NAME = 'tracks';

    let playlist = []; // {id,name,url}
    let currentIndex = -1;

    function openDB(){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    function saveBlobToDB(id, name, blob){
      return openDB().then(db => new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        store.put({ id, name, blob, created: Date.now() });
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      }));
    }

    function getBlobFromDB(id){
      return openDB().then(db => new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const req = store.get(id);
        req.onsuccess = () => resolve(req.result ? req.result.blob : null);
        req.onerror = () => reject(req.error);
      }));
    }

    function deleteBlobFromDB(id){
      return openDB().then(db => new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        store.delete(id);
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
      }));
    }

    function savePlaylistToStorage(){
      const data = playlist.map(p => ({ id: p.id, name: p.name }));
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch(e) { console.warn('Failed to save playlist', e); }
    }

    async function loadPlaylistFromStorage(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const saved = JSON.parse(raw);
        for (const s of saved){
          const blob = await getBlobFromDB(s.id);
          if (!blob) continue; // skip missing blobs
          const url = URL.createObjectURL(blob);
          playlist.push({ id: s.id, name: s.name, url });
        }
        renderPlaylist();
      } catch(e){ console.warn('Failed to load playlist', e); }
    }

    async function addFiles(files){
      for (const file of Array.from(files)){
        if (!file.type.startsWith('audio/')) continue;
        const id = Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8);
        try { await saveBlobToDB(id, file.name, file); } catch(e){ console.warn('Failed to save blob', e); }
        const url = URL.createObjectURL(file);
        playlist.push({ id, name: file.name, url });
      }
      renderPlaylist();
      savePlaylistToStorage();
      if (playlist.length && audioPlayer.paused) playTrack(playlist.length - 1);
    }

    function renderPlaylist(){
      playlistEl.innerHTML = '';
      playlist.forEach((p, i) => {
        const a = document.createElement('a');
        a.className = 'side-item';
        a.href = '#';
        a.setAttribute('data-id', p.id);
        a.innerHTML = `<div class="meta"><div class="name">${p.name}</div><div class="cat">Uploaded</div></div>`;
        a.addEventListener('click', (e)=>{ e.preventDefault(); playTrack(i); });

        const controlsWrap = document.createElement('div');
        controlsWrap.style.display = 'flex';
        controlsWrap.style.gap = '8px';

        const editBtn = document.createElement('button');
        editBtn.className = 'btn small';
        editBtn.textContent = 'Edit';
        editBtn.title = 'Rename track';
        editBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); renameTrack(i); });

        const removeBtn = document.createElement('button');
        removeBtn.className = 'btn small';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); removeTrack(i); });

        controlsWrap.appendChild(editBtn);
        controlsWrap.appendChild(removeBtn);
        a.appendChild(controlsWrap);

        if (i === currentIndex) a.classList.add('active');
        playlistEl.appendChild(a);
      });
    }

    function playTrack(index){
      const t = playlist[index];
      if (!t) return;
      currentIndex = index;
      audioPlayer.src = t.url;
      audioPlayer.play().catch(()=>{});
      [...playlistEl.querySelectorAll('.side-item')].forEach((r, i) => r.classList.toggle('active', i===index));
    }

    async function removeTrack(index){
      const t = playlist[index];
      if (t){
        try { URL.revokeObjectURL(t.url); } catch(e){}
        try { await deleteBlobFromDB(t.id); } catch(e){ console.warn('Failed to delete blob from DB', e); }
      }
      playlist.splice(index,1);
      if (currentIndex === index) { audioPlayer.pause(); audioPlayer.removeAttribute('src'); currentIndex = -1; }
      else if (currentIndex > index) currentIndex--;
      renderPlaylist();
      savePlaylistToStorage();
    }

    function renameTrack(index){
      const t = playlist[index];
      if (!t) return;
      const newName = prompt('Rename track', t.name);
      if (newName === null) return; // cancelled
      const trimmed = newName.trim();
      if (trimmed.length === 0) return alert('Name cannot be empty');
      playlist[index].name = trimmed;
      // update DB record name too
      saveBlobToDB(t.id, trimmed, null).catch(()=>{}); // if blob null, put will still update name if record exists
      renderPlaylist();
      savePlaylistToStorage();
    }

    // wire inputs
    fileInput.addEventListener('change', (e)=> addFiles(e.target.files));
    ['dragenter','dragover'].forEach(ev => playerContainer.addEventListener(ev, (e)=>{ e.preventDefault(); playerContainer.style.outline = '2px dashed #b88640'; }));
    ['dragleave','drop'].forEach(ev => playerContainer.addEventListener(ev, (e)=>{ e.preventDefault(); playerContainer.style.outline = 'none'; }));
    playerContainer.addEventListener('drop', (e)=>{ const items = e.dataTransfer.files; addFiles(items); });

    // load saved playlist
    window.addEventListener('load', ()=> loadPlaylistFromStorage());

    // ===== EMERGENCY CLOAKING =====
    const cloakPresets = [
      { title: "Google", favicon: "https://www.google.com/favicon.ico" },
      { title: "Google Docs", favicon: "https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico" },
      { title: "Google Classroom", favicon: "https://ssl.gstatic.com/classroom/favicon.png" },
      { title: "Canvas", favicon: "https://du11hjcvx0uqb.cloudfront.net/dist/images/favicon-e10d657a73.ico" },
      { title: "Gmail", favicon: "https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico" },
      { title: "Google Drive", favicon: "https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png" },
      { title: "Google Slides", favicon: "https://ssl.gstatic.com/docs/presentations/images/favicon5.ico" },
      { title: "Google Sheets", favicon: "https://ssl.gstatic.com/docs/spreadsheets/favicon3.ico" },
      { title: "YouTube", favicon: "https://www.youtube.com/s/desktop/6e6c14c5/img/favicon_32x32.png" },
      { title: "Wikipedia", favicon: "https://www.wikipedia.org/static/favicon/wikipedia.ico" }
    ];

    const cloakBtn = document.getElementById('emergencyCloakBtn');
    if (cloakBtn) {
      cloakBtn.addEventListener('click', () => {
        const randomPreset = cloakPresets[Math.floor(Math.random() * cloakPresets.length)];
        document.title = randomPreset.title;
        const icon = document.querySelector('link[rel="icon"]');
        if (icon) icon.href = randomPreset.favicon;
        localStorage.setItem('cloakTitle', randomPreset.title);
        localStorage.setItem('cloakFavicon', randomPreset.favicon);
      });
    }

    // Apply saved cloak on page load
    const savedTitle = localStorage.getItem('cloakTitle');
    const savedFavicon = localStorage.getItem('cloakFavicon');
    if(savedTitle) {
      document.title = savedTitle;
    }
    if(savedFavicon) {
      const icon = document.querySelector('link[rel="icon"]');
      if (icon) icon.href = savedFavicon;
    }
  </script>
</body>
</html>
